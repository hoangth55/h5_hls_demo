'use strict';self.importScripts("common.js");self.importScripts("loader-hls.js");self.importScripts("loader-http.js");function Downloader(){this.loader=null;this.seq=0;this.state=kStatePause;this.logger=new Logger("Downloader");this.bInit=0;this.timerRequest=null}Downloader.prototype.appendBuffer=function(a,b){let c=new Uint8Array(a.byteLength+b.byteLength);c.set(new Uint8Array(a),0);c.set(new Uint8Array(b),a.byteLength);return c.buffer};Downloader.prototype.reportMsg=function(a){self.postMessage(a)};
Downloader.prototype.reportData=function(a){let b=a.byteLength,c=0;if(4096<b){do{var d=Math.min(4096,b);let f=a.slice(c,c+d);b-=d;c+=d;d={t:kUriData,d:f,q:this.seq};self.postMessage(d,[d.d])}while(0<b)}else a={t:kUriData,d:a,q:this.seq},self.postMessage(a,[a.d])};
Downloader.prototype.fnInit_DL=function(a,b,c,d,f){this.seq=d;this.loader&&(this.loader.fnDestory(),this.loader=null);let h=this;fetch("./profile").then(k=>{k.text().then(e=>{if(e&&""!=e)try{let g={t:kRsp_ProfileData,data:JSON.parse(e)};self.postMessage(g);h.m_szLic=e}catch(g){}})});switch(a){case kProtoType_HTTP_M3U8:this.loader=new LoaderHLS;this.loader.fnInit(b,c,g_nTimeout_Default);this.loader.fnStart();this.state=kStateDownloading;break;case kProtoType_HTTP:this.loader=new LoaderHTTP;this.loader.fnInit(b,
c,d,g_nTimeout_Default);this.state=kStatePause;this.loader.fnStart();this.state=kStateDownloading;break;default:this.logger.logError("Invalid protocol "+a)}self.postMessage({t:kRsp_DownloadStart,e:0,q:self.downloader.seq,u:f})};Downloader.prototype.start=function(){if(null==this.loader)return-1;this.state=kStateDownloading};Downloader.prototype.stop=function(){null!=this.loader&&(this.loader.fnDestory(),this.loader=null,this.state=kStatePause);self.postMessage({t:kRsp_DownloadStop,e:0,q:this.seq})};
Downloader.prototype.pause=function(){null!=this.loader&&(this.loader.fnPause(),this.state=kStatePause);self.postMessage({t:kRsp_DownloadPause,e:0,q:this.seq})};Downloader.prototype.resume=function(){null!=this.loader&&(this.loader.fnStart(),this.state=kStateDownloading);self.postMessage({t:kRsp_DownloadResume,e:0,q:this.seq})};Downloader.prototype.skipTime=function(a){self.postMessage({t:kRsp_DownloadChangeTime,s:a.index,e:0,q:this.seq})};self.downloader=new Downloader;
self.onmessage=function(a){if(self.downloader)switch(a=a.data,a.t){case kReq_DownloadStart:self.downloader.fnInit_DL(a.p,a.u,a.i,a.q,a.k);break;case kReq_DownloadStop:self.downloader.stop();break;case kReq_DownloadPause:self.downloader.pause();break;case kReq_DownloadResume:self.downloader.resume();break;case kReq_DecoderSkipTime:self.downloader.skipTime(a);break;default:self.downloader.logger.logError("Unsupport messsage "+a.t)}else console.log("[ER] Downloader not initialized!"),self.postMessage({t:kRsp_DownloadStart,
e:-1})};