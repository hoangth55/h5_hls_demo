'use strict';function LoaderHTTP(){this.m_szUrl=null;this.m_nSeq=0;this.m_bIsStream=!0;this.m_pFetchCtl=null;this.m_nTimeout=g_nTimeout_Default;this.m_nTimeoutCount=0;this.m_nChunkSize=g_nChunkSize_Default;this.m_bRun=!1;this.m_pLogger=new Logger("LoaderHTTP")}LoaderHTTP.prototype.fnInit=function(a,f,e,g){if(null==a)return Error_Loader_Param;this.m_pFetchCtl&&(this.m_pFetchCtl.abort(),this.m_pFetchCtl=null);this.m_bIsStream=f;this.m_szUrl=a;this.m_nSeq=e;this.m_nTimeout=g||g_nTimeout_Default;return EE_Loader_OK};
LoaderHTTP.prototype.fnStart=function(){let a=this;this.m_pFetchCtl=new AbortController;let f=this.m_pFetchCtl.signal;f.onabort=function(){a.m_pFetchCtl=null};fetch(this.m_szUrl,{signal:f,mode:"cors"}).then(async function(e){const g=e.body.getReader();g.read().then(function k({done:b,value:c}){if(b)a.m_pFetchCtl=null,a.m_pLogger.logInfo("Stream done."),self.postMessage({t:kUriDataFinished}),a.m_bRun=!1;else if(a.m_bRun){b=c.byteLength;var h=0;if(b>a.m_nChunkSize){do{var d=Math.min(a.m_nChunkSize,
b);let l=c.buffer.slice(h,h+d);b-=d;h+=d;d={t:kUriData,d:l,q:a.m_nSeq};self.postMessage(d,[d.d])}while(0<b)}else c={t:kUriData,d:c.buffer,q:a.m_nSeq},self.postMessage(c,[c.d]);return g.read().then(k)}}).catch(function(b){"AbortError"===b.name?a.m_pLogger.logInfo("Fetch aborted."):(a.m_pLogger.logError("Fetch read error:",b),self.postMessage({t:kUriDataError}),a.m_bRun=!1,a.m_pFetchCtl=null)})}).catch(e=>{a.m_pLogger.logInfo("Fetch error:",e);self.postMessage({t:kUriDataError});a.m_bRun=!1;a.m_pFetchCtl=
null});this.m_bRun=!0};LoaderHTTP.prototype.fnPause=function(){this.m_pFetchCtl&&(this.m_pFetchCtl.abort(),this.m_pFetchCtl=null);this.m_bRun=!1;this.m_pLogger.logInfo("Pause.")};LoaderHTTP.prototype.fnDestory=function(){this.fnPause();this.m_pLogger.logInfo("Destroy.")};